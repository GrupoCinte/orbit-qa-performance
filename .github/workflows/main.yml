name: K6 Load Tests - QA

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  QA_URL: ${{ secrets.QA_URL }}
  TEST_TYPE: loadTest
  DOCKER_IMAGE: grafana/k6:latest

jobs:
  k6-load-tests:
    runs-on: ubuntu-latest

    steps:
      # Clonar el repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # Crear carpeta de reportes
      - name: Create reports directory
        run: mkdir -p reports

      # Ejecutar pruebas de carga con k6 en Docker
      - name: Run k6 load tests
        run: |
          docker run --rm \
            -e BASE_URL=${{ env.QA_URL }} \
            -e TEST_TYPE=${{ env.TEST_TYPE }} \
            -v ${{ github.workspace }}/src:/scripts \
            -v ${{ github.workspace }}/data:/data \
            -v ${{ github.workspace }}/reports:/reports \
            ${{ env.DOCKER_IMAGE }} \
            run /scripts/prueba_flujo_mejorada.js \
            --out json=/reports/results.json \
            --out text=/reports/results.txt
        continue-on-error: true

      # Mostrar resumen de resultados en logs
      - name: Show test results
        if: always()
        run: |
          echo "K6 LOAD TEST RESULTS - QA"
          if [ -f reports/results.txt ]; then
            cat reports/results.txt
          else
            echo "No results available"
          fi

      # Subir reportes como artefactos
      - name: Upload k6 reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: k6-qa-load-test-reports
          path: reports/
          retention-days: 30

      # Notificaci√≥n de estado
      - name: Workflow status
        if: always()
        run: |
          if [ -f reports/results.txt ]; then
            echo "Pruebas completadas. Revisa los reportes."
          else
            echo "Advertencia: No se generaron reportes"
          fi
