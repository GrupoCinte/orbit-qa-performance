name: K6 Load Tests - QA

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  QA_URL: ${{ secrets.QA_URL }}
  TEST_TYPE: loadTest
  DOCKER_IMAGE: grafana/k6:latest

jobs:
  k6-load-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create reports directory
        run: mkdir -p reports

      - name: Run k6 load tests
        run: |
          docker run --rm \
            --user root \
            -e BASE_URL=${{ env.QA_URL }} \
            -e TEST_TYPE=${{ env.TEST_TYPE }} \
            -v $(pwd)/src:/src \
            -v $(pwd)/data:/data \
            -v $(pwd)/reports:/reports \
            ${{ env.DOCKER_IMAGE }} \
            run /src/prueba_flujo_mejorada.js \
            --summary-export=/reports/summary.json \
            --out json=/reports/results.json
        continue-on-error: true

      - name: List generated reports
        if: always()
        run: |
          echo "Reports generated:"
          ls -lah reports/

      - name: Upload k6 reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-qa-load-test-reports-${{ github.run_number }}
          path: reports/
          retention-days: 30